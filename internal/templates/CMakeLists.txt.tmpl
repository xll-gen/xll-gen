# Code generated by xll-gen {{.Version}}. DO NOT EDIT.
cmake_minimum_required(VERSION 3.24)
project({{ .ProjectName }} LANGUAGES C CXX)

if(WIN32)
    enable_language(RC)
endif()

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/..)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

# Flatbuffers
FetchContent_Declare(
  flatbuffers
  GIT_REPOSITORY https://github.com/google/flatbuffers.git
  GIT_TAG {{ .Deps.FlatBuffers }}
)
set(FLATBUFFERS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_SAMPLES OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_FLATC OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(flatbuffers)

# SHM
FetchContent_Declare(
  shm
  GIT_REPOSITORY https://github.com/xll-gen/shm.git
  GIT_TAG {{ .Deps.SHM }}
)
FetchContent_MakeAvailable(shm)

# Types (Excel Types & Utils)
FetchContent_Declare(
  types
  GIT_REPOSITORY https://github.com/xll-gen/types.git
  GIT_TAG {{ .Deps.Types }}
)
set(TYPES_BUILD_TESTS OFF CACHE BOOL "" FORCE)
FetchContent_GetProperties(types)
if(NOT types_POPULATED)
  FetchContent_Populate(types)
  add_subdirectory(${types_SOURCE_DIR} ${types_BINARY_DIR} EXCLUDE_FROM_ALL)

  # Suppress cast-function-type warning in xll-gen-types (xlcall.cpp uses GetProcAddress with cast)
  if(NOT MSVC AND TARGET xll-gen-types)
      target_compile_options(xll-gen-types PRIVATE -Wno-cast-function-type)
  endif()
endif()

# Parallel Hashmap
FetchContent_Declare(
  phmap
  GIT_REPOSITORY https://github.com/greg7mdp/parallel-hashmap.git
  GIT_TAG {{ .Deps.PHMAP }}
)
set(PHMAP_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(PHMAP_BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(phmap)

if(NOT TARGET shm)
  add_library(shm INTERFACE)
  target_include_directories(shm INTERFACE ${shm_SOURCE_DIR}/include)
endif()

{{ if eq .Build.Singlefile "xll" }}
# ==============================================================================
# Embedding Executable in XLL (exe_in_xll mode / singlefile: xll)
# ==============================================================================

FetchContent_Declare(
  zstd
  GIT_REPOSITORY https://github.com/facebook/zstd.git
  GIT_TAG {{ .Deps.Zstd }}
  SOURCE_SUBDIR build/cmake
)
set(ZSTD_BUILD_PROGRAMS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_SHARED OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_STATIC ON CACHE BOOL "" FORCE)
set(ZSTD_LEGACY_SUPPORT OFF CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(zstd)

add_executable(compressor "${CMAKE_CURRENT_SOURCE_DIR}/tools/compressor.cpp")
target_link_libraries(compressor PRIVATE libzstd_static)
target_include_directories(compressor PRIVATE ${zstd_SOURCE_DIR}/lib)

if(NOT DEFINED GO_SERVER_EXE_PATH)
    message(FATAL_ERROR "GO_SERVER_EXE_PATH must be defined via -DGO_SERVER_EXE_PATH=...")
endif()

# GO_SERVER_EXE_PATH is passed relative to the project root (where Taskfile is run).
# The project root is two levels up from CMAKE_CURRENT_SOURCE_DIR (generated/cpp).
get_filename_component(PROJECT_ROOT "${CMAKE_CURRENT_SOURCE_DIR}/../.." ABSOLUTE)
set(GO_EXE "${PROJECT_ROOT}/${GO_SERVER_EXE_PATH}")

if(NOT EXISTS "${GO_EXE}")
    message(FATAL_ERROR "Go binary not found at: ${GO_EXE}. Ensure it is built before running CMake.")
endif()

set(ZSTD_BINARY_NAME "go_server.zst")
set(ZSTD_OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${ZSTD_BINARY_NAME}")

add_custom_command(
    OUTPUT ${ZSTD_OUTPUT_PATH}
    COMMAND $<TARGET_FILE:compressor> ${GO_EXE} ${ZSTD_OUTPUT_PATH}
    DEPENDS compressor ${GO_EXE}
    COMMENT "Compressing Go binary with Zstd..."
)

if(WIN32)
    set(RC_FILE "${CMAKE_CURRENT_BINARY_DIR}/embedded_resource.rc")
    file(WRITE ${RC_FILE} "101 RCDATA \"${ZSTD_OUTPUT_PATH}\"")

    # Explicitly state that compiling the RC file depends on the ZST file being created.
    set_source_files_properties(${RC_FILE} PROPERTIES OBJECT_DEPENDS "${ZSTD_OUTPUT_PATH}")
endif()

{{ end }}

file(GLOB SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/xll_main.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp"
)

{{ if eq .Build.Singlefile "xll" }}
if(WIN32)
    list(APPEND SOURCES ${RC_FILE})
endif()
{{ end }}

add_library(${PROJECT_NAME} SHARED ${SOURCES})

target_include_directories(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/include
)

target_link_libraries(${PROJECT_NAME} PRIVATE
  shm
  xll-gen-types
  flatbuffers
  phmap
)

{{ if .Rtd.Enabled }}
target_compile_definitions(${PROJECT_NAME} PRIVATE XLL_RTD_ENABLED)
if(WIN32)
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ole32
        oleaut32
        uuid
    )
endif()
{{ end }}

{{ if eq .Build.Singlefile "xll" }}
target_link_libraries(${PROJECT_NAME} PRIVATE libzstd_static)
target_include_directories(${PROJECT_NAME} PRIVATE ${zstd_SOURCE_DIR}/lib)
target_compile_definitions(${PROJECT_NAME} PRIVATE EMBED_GO_SERVER)
{{ end }}

if(XLL_DEBUG)
  target_compile_definitions(${PROJECT_NAME} PRIVATE SHM_DEBUG XLL_DEBUG_LOGGING)
endif()

if(WIN32)
  # Prevent collision between shm/Logger.h (LogLevel::ERROR) and windows.h (ERROR macro)
  target_compile_definitions(${PROJECT_NAME} PRIVATE NOGDI)
endif()

if(MSVC)
  target_compile_options(${PROJECT_NAME} PRIVATE
    /utf-8
    $<$<CONFIG:Release>:/arch:AVX2>
  )
else()
  target_compile_options(${PROJECT_NAME} PRIVATE
    -fexceptions
    -fnon-call-exceptions
    -Wno-stringop-overread
    -Wno-pragma-once-outside-header
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-mavx2>
    $<$<CONFIG:Release>:-flto>
  )
  target_link_options(${PROJECT_NAME} PRIVATE
    -static-libgcc
    -static-libstdc++
    $<$<CONFIG:Release>:-flto>
    $<$<CONFIG:Release>:-s>
  )
endif()

set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "" SUFFIX ".xll")
