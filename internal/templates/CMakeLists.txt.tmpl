# Code generated by xll-gen {{.Version}}. DO NOT EDIT.
cmake_minimum_required(VERSION 3.14)
project({{ .ProjectName }} LANGUAGES C CXX)

if(WIN32)
    enable_language(RC)
endif()

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/..)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

# Flatbuffers
FetchContent_Declare(
  flatbuffers
  GIT_REPOSITORY https://github.com/google/flatbuffers.git
  GIT_TAG v25.9.23
)
set(FLATBUFFERS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_SAMPLES OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_FLATC OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(flatbuffers)

# SHM
FetchContent_Declare(
  shm
  GIT_REPOSITORY https://github.com/xll-gen/shm.git
  GIT_TAG v0.4.0
)
FetchContent_MakeAvailable(shm)

if(NOT TARGET shm)
  add_library(shm INTERFACE)
  target_include_directories(shm INTERFACE ${shm_SOURCE_DIR}/include)
endif()

{{ if eq .Embed.Mode "exe_in_xll" }}
# ==============================================================================
# Embedding Executable in XLL (exe_in_xll mode)
# ==============================================================================

# 1. Fetch Zstd
FetchContent_Declare(
  zstd
  GIT_REPOSITORY https://github.com/facebook/zstd.git
  GIT_TAG v1.5.5
)
set(ZSTD_BUILD_PROGRAMS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_SHARED OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_STATIC ON CACHE BOOL "" FORCE)

# Manually populate and add subdirectory to ensure targets are defined correctly
FetchContent_GetProperties(zstd)
if(NOT zstd_POPULATED)
  FetchContent_Populate(zstd)
  add_subdirectory(${zstd_SOURCE_DIR}/build/cmake ${zstd_BINARY_DIR})
endif()

# 2. Build Compressor Tool
add_executable(compressor "${CMAKE_CURRENT_SOURCE_DIR}/tools/compressor.cpp")
target_link_libraries(compressor PRIVATE libzstd_static)
target_include_directories(compressor PRIVATE ${zstd_SOURCE_DIR}/lib)

# 3. Build Go Binary
set(GO_EXE "${CMAKE_CURRENT_BINARY_DIR}/go_server.exe")
# Glob source files in parent directory (project root) to track dependencies
file(GLOB GO_SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/../*.go")

add_custom_command(
    OUTPUT ${GO_EXE}
    # Build from the project root (where go.mod is located)
    COMMAND go build -ldflags="-s -w" -o ${GO_EXE} ./generated
    WORKING_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/../.."
    DEPENDS ${GO_SOURCES}
    COMMENT "Building Go binary..."
)

# 4. Compress Go Binary
set(ZSTD_BINARY_NAME "go_server.zst")
set(ZSTD_OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${ZSTD_BINARY_NAME}")

add_custom_command(
    OUTPUT ${ZSTD_OUTPUT_PATH}
    COMMAND $<TARGET_FILE:compressor> ${GO_EXE} ${ZSTD_OUTPUT_PATH}
    DEPENDS compressor ${GO_EXE}
    COMMENT "Compressing Go binary with Zstd..."
)

# 5. Generate Resource File
if(WIN32)
    set(RC_FILE "${CMAKE_CURRENT_BINARY_DIR}/embedded_resource.rc")
    file(WRITE ${RC_FILE} "101 RCDATA \"${ZSTD_OUTPUT_PATH}\"")

    # Explicitly state that compiling the RC file depends on the ZST file being created.
    set_source_files_properties(${RC_FILE} PROPERTIES OBJECT_DEPENDS "${ZSTD_OUTPUT_PATH}")
endif()

{{ end }}

file(GLOB SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/xll_main.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/include/*.cpp"
)

{{ if eq .Embed.Mode "exe_in_xll" }}
if(WIN32)
    list(APPEND SOURCES ${RC_FILE})
endif()
{{ end }}

add_library(${PROJECT_NAME} SHARED ${SOURCES})

target_include_directories(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/include
)

target_link_libraries(${PROJECT_NAME} PRIVATE
  shm
  flatbuffers
)

{{ if eq .Embed.Mode "exe_in_xll" }}
target_link_libraries(${PROJECT_NAME} PRIVATE libzstd_static)
target_include_directories(${PROJECT_NAME} PRIVATE ${zstd_SOURCE_DIR}/lib)
{{ end }}

if(NOT MSVC)
  target_compile_options(${PROJECT_NAME} PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-march=native>
    $<$<CONFIG:Release>:-flto>
  )
  target_link_options(${PROJECT_NAME} PRIVATE $<$<CONFIG:Release>:-flto>)
endif()

set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "" SUFFIX ".xll")
