# Code generated by xll-gen {{.Version}}. DO NOT EDIT.
cmake_minimum_required(VERSION 3.14)
project({{ .ProjectName }} LANGUAGES CXX RC)

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/..)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

# Flatbuffers
FetchContent_Declare(
  flatbuffers
  GIT_REPOSITORY https://github.com/google/flatbuffers.git
  GIT_TAG v25.9.23
)
set(FLATBUFFERS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_SAMPLES OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_FLATC OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(flatbuffers)

# SHM
FetchContent_Declare(
  shm
  GIT_REPOSITORY https://github.com/xll-gen/shm.git
  GIT_TAG v0.4.0
)
FetchContent_MakeAvailable(shm)

if(NOT TARGET shm)
  add_library(shm INTERFACE)
  target_include_directories(shm INTERFACE ${shm_SOURCE_DIR}/include)
endif()

{{ if eq .Embed.Mode "exe_in_xll" }}
# ==============================================================================
# Embedding Executable in XLL (exe_in_xll mode)
# ==============================================================================

# 1. Fetch Zstd
FetchContent_Declare(
  zstd
  GIT_REPOSITORY https://github.com/facebook/zstd.git
  GIT_TAG v1.5.5
)
# Disable Zstd standard targets to avoid conflicts and speed up
set(ZSTD_BUILD_PROGRAMS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_SHARED OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(zstd)


# 2. Build Compressor Tool
add_executable(compressor "${CMAKE_CURRENT_SOURCE_DIR}/tools/compressor.cpp")
add_dependencies(compressor zstd_static)
target_link_libraries(compressor PRIVATE zstd_static)

# 3. Compress Pre-built Go Binary
# The GO_SERVER_EXE_PATH is provided by the Taskfile, which ensures the Go binary is built first.
set(GO_SERVER_EXE_PATH "" CACHE FILEPATH "Path to the pre-built Go server executable")
if(NOT EXISTS "${GO_SERVER_EXE_PATH}")
    message(FATAL_ERROR "GO_SERVER_EXE_PATH is not set or file does not exist: ${GO_SERVER_EXE_PATH}")
endif()

set(ZSTD_BINARY_NAME "go_server.zst")
set(ZSTD_OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${ZSTD_BINARY_NAME}")

add_custom_command(
    OUTPUT ${ZSTD_OUTPUT_PATH}
    COMMAND $<TARGET_FILE:compressor> ${GO_SERVER_EXE_PATH} ${ZSTD_OUTPUT_PATH}
    DEPENDS compressor "${GO_SERVER_EXE_PATH}" # Depend on the pre-built exe
    COMMENT "Compressing pre-built Go binary with Zstd..."
)

add_custom_target(GenerateCompressedGo DEPENDS ${ZSTD_OUTPUT_PATH})

# 4. Generate Resource File
set(RC_FILE "${CMAKE_CURRENT_BINARY_DIR}/embedded_resource.rc")
file(WRITE ${RC_FILE} "101 RCDATA \"${ZSTD_OUTPUT_PATH}\"")

# Explicitly state that compiling the RC file depends on the ZST file being created.
set_source_files_properties(${RC_FILE} PROPERTIES OBJECT_DEPENDS "${ZSTD_OUTPUT_PATH}")

{{ end }}

file(GLOB SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/xll_main.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/include/*.cpp"
)

{{ if eq .Embed.Mode "exe_in_xll" }}
list(APPEND SOURCES ${RC_FILE})
{{ end }}

add_library(${PROJECT_NAME} SHARED ${SOURCES})

target_include_directories(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/include
)

target_link_libraries(${PROJECT_NAME} PRIVATE
  shm
  flatbuffers
)

{{ if eq .Embed.Mode "exe_in_xll" }}
add_dependencies(${PROJECT_NAME} zstd_static)
target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_BINARY_DIR})
target_link_libraries(${PROJECT_NAME} PRIVATE zstd_static)
{{ end }}

if(NOT MSVC)
  target_compile_options(${PROJECT_NAME} PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-march=native>
    $<$<CONFIG:Release>:-flto>
  )
  target_link_options(${PROJECT_NAME} PRIVATE $<$<CONFIG:Release>:-flto>)
endif()

set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "" SUFFIX ".xll")