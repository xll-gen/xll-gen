# Code generated by xll-gen {{.Version}}. DO NOT EDIT.
cmake_minimum_required(VERSION 3.14)
project({{ .ProjectName }} LANGUAGES CXX RC)

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/..)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

# Flatbuffers
FetchContent_Declare(
  flatbuffers
  GIT_REPOSITORY https://github.com/google/flatbuffers.git
  GIT_TAG v25.9.23
)
set(FLATBUFFERS_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_SAMPLES OFF CACHE BOOL "" FORCE)
set(FLATBUFFERS_BUILD_FLATC OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(flatbuffers)

# SHM
FetchContent_Declare(
  shm
  GIT_REPOSITORY https://github.com/xll-gen/shm.git
  GIT_TAG main
)
FetchContent_MakeAvailable(shm)

if(NOT TARGET shm)
  add_library(shm INTERFACE)
  target_include_directories(shm INTERFACE ${shm_SOURCE_DIR}/include)
endif()

{{ if eq .Embed.Mode "exe_in_xll" }}
# ==============================================================================
# Embedding Executable in XLL (exe_in_xll mode)
# ==============================================================================

# 1. Fetch Zstd
FetchContent_Declare(
  zstd
  GIT_REPOSITORY https://github.com/facebook/zstd.git
  GIT_TAG v1.5.5
)
# Disable Zstd standard targets to avoid conflicts and speed up
set(ZSTD_BUILD_PROGRAMS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(ZSTD_BUILD_SHARED OFF CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(zstd)

# Ensure libzstd_static is available
if(NOT TARGET libzstd_static)
  # Fallback if FetchContent behaves differently (usually exposes libzstd_static)
  message(STATUS "libzstd_static target not found, attempting to use zstd::libzstd_static")
endif()


# 2. Build Compressor Tool
add_executable(compressor "${CMAKE_CURRENT_SOURCE_DIR}/tools/compressor.cpp")
target_link_libraries(compressor PRIVATE libzstd_static)

# 3. Build Go and Compress
set(GO_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../../") # Root of project
set(GO_BINARY_NAME "go_server.exe")
set(GO_OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${GO_BINARY_NAME}")
set(ZSTD_BINARY_NAME "go_server.zst")
set(ZSTD_OUTPUT_PATH "${CMAKE_CURRENT_BINARY_DIR}/${ZSTD_BINARY_NAME}")

find_program(GO_EXE NAMES go REQUIRED)

# Determine Go Build Flags based on Configuration
# Release: Strip symbols (-s -w) for size
# Debug:   Disable optimizations (-gcflags="all=-N -l") for debugging
set(GO_FLAGS_RELEASE "-ldflags='-s -w'")
set(GO_FLAGS_DEBUG "-gcflags='all=-N -l'")

add_custom_command(
    OUTPUT ${ZSTD_OUTPUT_PATH}
    COMMAND ${GO_EXE} build $<$<CONFIG:Debug>:${GO_FLAGS_DEBUG}> $<$<CONFIG:Release>:${GO_FLAGS_RELEASE}> $<$<CONFIG:RelWithDebInfo>:${GO_FLAGS_RELEASE}> -o ${GO_OUTPUT_PATH} .
    COMMAND $<TARGET_FILE:compressor> ${GO_OUTPUT_PATH} ${ZSTD_OUTPUT_PATH}
    WORKING_DIRECTORY ${GO_SOURCE_DIR}
    DEPENDS compressor "${GO_SOURCE_DIR}/server.go" "${GO_SOURCE_DIR}/main.go" # Basic dependency check
    COMMENT "Building Go binary and compressing with Zstd..."
)

add_custom_target(GenerateCompressedGo DEPENDS ${ZSTD_OUTPUT_PATH})

# 4. Generate Resource File
# We create a resource.h and resource.rc on the fly if not present,
# but since we need it linked, we can generate a simple one here.
# However, to be cleaner, we will create a temporary .rc file.

set(RC_FILE "${CMAKE_CURRENT_BINARY_DIR}/embedded_resource.rc")
file(WRITE ${RC_FILE} "101 RCDATA \"${ZSTD_BINARY_NAME}\"")

{{ end }}

file(GLOB SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/xll_main.cpp"
    "${CMAKE_CURRENT_SOURCE_DIR}/include/*.cpp"
)

{{ if eq .Embed.Mode "exe_in_xll" }}
list(APPEND SOURCES ${RC_FILE})
{{ end }}

add_library(${PROJECT_NAME} SHARED ${SOURCES})

target_include_directories(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/include
)

target_link_libraries(${PROJECT_NAME} PRIVATE
  shm
  flatbuffers
  winmm
)

{{ if eq .Embed.Mode "exe_in_xll" }}
target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_BINARY_DIR})
target_link_libraries(${PROJECT_NAME} PRIVATE libzstd_static)
add_dependencies(${PROJECT_NAME} GenerateCompressedGo)
{{ end }}

if(NOT MSVC)
  target_compile_options(${PROJECT_NAME} PRIVATE
    $<$<CONFIG:Release>:-O3>
    $<$<CONFIG:Release>:-march=native>
    $<$<CONFIG:Release>:-flto>
  )
  target_link_options(${PROJECT_NAME} PRIVATE $<$<CONFIG:Release>:-flto>)
endif()

set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "" SUFFIX ".xll")
